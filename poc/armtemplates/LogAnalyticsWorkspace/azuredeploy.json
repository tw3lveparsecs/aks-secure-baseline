{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspaceName": {
            "type": "string",
            "metadata": {
                "description": "Name of the workspace."
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location of the workspace."
            }
        },
        "sku": {
            "type": "string",
            "allowedValues": [
                "pergb2018",
                "Free",
                "Standalone",
                "PerNode",
                "Standard",
                "Premium"
            ],
            "metadata": {
                "description": "Service tier of the workspace: Standalone, PerNode, Per-GB, etc."
            }
        },
        "dataRetention": {
            "type": "int",
            "minValue": 7,
            "maxValue": 730,
            "metadata": {
                "description": "Data retention period."
            }
        },
        "diagnosticStorageAccountName": {
            "type": "string",
            "metadata": {
                "description": "Diagnostic storage accounnt name."
            }
        },
        "diagnosticStorageAccountResourceGroup": {
            "type": "string",
            "metadata": {
                "description": "Diagnostics storage account resource group."
            }
        }
    },
    "variables": {
        "solutions": [
            "ContainerInsights"
        ],
        "diagnosticRetentionInDays": 30
    },
    "resources": [
        {
            "type": "Microsoft.OperationalInsights/workspaces",
            "name": "[parameters('workspaceName')]",
            "apiVersion": "2020-08-01",
            "location": "[parameters('location')]",
            "properties": {
                "sku": {
                    "Name": "[parameters('sku')]"
                },
                "retentionInDays": "[parameters('dataRetention')]",
                "features": {
                    "searchVersion": 1
                }
            }
        },
        {
            "apiVersion": "2020-08-01",
            "name": "[concat(parameters('workspaceName'), '/PrometheusQuery1')]",            
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "properties": {
                "eTag": "*",
                "category": "Prometheus",
                "displayName": "All collected Prometheus information",
                "query": "InsightsMetrics | where Namespace == \"prometheus\"",
                "version": 1
            }
        },
        {
            "apiVersion": "2020-08-01",
            "name": "[concat(parameters('workspaceName'), '/PrometheusQuery2')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "properties": {
                "eTag": "*",
                "category": "Prometheus",
                "displayName": "Increase number of forbidden response on the Ingress Controller",
                "query": "let value = toscalar(InsightsMetrics | where Namespace == \"prometheus\" and Name == \"traefik_entrypoint_requests_total\" | where parse_json(Tags).code == 403 | summarize Value = avg(Val) by bin(TimeGenerated, 5m) | summarize min = min(Value)); InsightsMetrics | where Namespace == \"prometheus\" and Name == \"traefik_entrypoint_requests_total\" | where parse_json(Tags).code == 403 | summarize AggregatedValue = avg(Val)-value by bin(TimeGenerated, 5m) | order by TimeGenerated | render barchart",
                "version": 1
            }
        },
        {
            "apiVersion": "2020-08-01",
            "name": "[concat(parameters('workspaceName'), '/PrometheusQuery3')]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "properties": {
                "eTag": "*",
                "category": "Prometheus",
                "displayName": "Nodes reboot required by kured",
                "query": "InsightsMetrics | where Namespace == \"prometheus\" and Name == \"kured_reboot_required\" | where Val > 0",
                "version": 1
            }
        },
        {
            "apiVersion": "2015-11-01-preview",
            "type": "Microsoft.OperationsManagement/solutions",
            "location": "[parameters('location')]",
            "name": "[concat(variables('solutions')[copyIndex()],'(', parameters('workspaceName'), ')')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            ],
            "copy": {
                "name": "solutioncopy",
                "count": "[length(variables('solutions'))]"
            },
            "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            },
            "plan": {
                "name": "[concat(variables('solutions')[copyIndex()],'(', parameters('workspaceName'), ')')]",
                "product": "[concat('OMSGallery/', variables('solutions')[copyIndex()])]",
                "promotionCode": "",
                "publisher": "Microsoft"
            }
        },
        {
            "apiVersion": "2015-11-01-preview",
            "type": "Microsoft.OperationsManagement/solutions",
            "location": "[parameters('location')]",
            "name": "[concat('AzureActivity','(', parameters('workspaceName'), ')')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            ],
            "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
                "containedResources": [
                    "[concat(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), concat('/views/', 'AzureActivity','(', parameters('workspaceName'), ')'))]"
                ]
            },
            "plan": {
                "name": "[concat('AzureActivity','(', parameters('workspaceName'), ')')]",
                "product": "OMSGallery/AzureActivity",
                "promotionCode": "",
                "publisher": "Microsoft"
            }
        },
        {
            "name": "PodFailedPhase",
            "type": "microsoft.insights/scheduledQueryRules",
            "apiVersion": "2018-04-16",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationsManagement/solutions',  concat('ContainerInsights(', parameters('workspaceName'), ')'))]"
            ],
            "properties": {
                "description": "Alert on pod Failed phase.",
                "enabled": "true",
                "source": {
                    "query": "[concat('//https://docs.microsoft.com/azure/azure-monitor/insights/container-insights-alerts \r\n let endDateTime = now(); let startDateTime = ago(1h); let trendBinSize = 1m; let clusterName = \"',variables('clusterName'),'\"; KubePodInventory | where TimeGenerated < endDateTime | where TimeGenerated >= startDateTime | where ClusterName == clusterName | distinct ClusterName, TimeGenerated | summarize ClusterSnapshotCount = count() by bin(TimeGenerated, trendBinSize), ClusterName | join hint.strategy=broadcast ( KubePodInventory | where TimeGenerated < endDateTime | where TimeGenerated >= startDateTime | distinct ClusterName, Computer, PodUid, TimeGenerated, PodStatus | summarize TotalCount = count(), PendingCount = sumif(1, PodStatus =~ \"Pending\"), RunningCount = sumif(1, PodStatus =~ \"Running\"), SucceededCount = sumif(1, PodStatus =~ \"Succeeded\"), FailedCount = sumif(1, PodStatus =~ \"Failed\") by ClusterName, bin(TimeGenerated, trendBinSize) ) on ClusterName, TimeGenerated | extend UnknownCount = TotalCount - PendingCount - RunningCount - SucceededCount - FailedCount | project TimeGenerated, TotalCount = todouble(TotalCount) / ClusterSnapshotCount, PendingCount = todouble(PendingCount) / ClusterSnapshotCount, RunningCount = todouble(RunningCount) / ClusterSnapshotCount, SucceededCount = todouble(SucceededCount) / ClusterSnapshotCount, FailedCount = todouble(FailedCount) / ClusterSnapshotCount, UnknownCount = todouble(UnknownCount) / ClusterSnapshotCount| summarize AggregatedValue = avg(FailedCount) by bin(TimeGenerated, trendBinSize)')]",
                    "dataSourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
                    "queryType": "ResultCount"
                },
                "schedule": {
                    "frequencyInMinutes": "5",
                    "timeWindowInMinutes": "10"
                },
                "action": {
                    "odata.type": "Microsoft.WindowsAzure.Management.Monitoring.Alerts.Models.Microsoft.AppInsights.Nexus.DataContracts.Resources.ScheduledQueryRules.AlertingAction",
                    "severity": "3",
                    "trigger": {
                        "thresholdOperator": "GreaterThan",
                        "threshold": "3",
                        "metricTrigger": {
                            "thresholdOperator": "GreaterThan",
                            "threshold": "2",
                            "metricTriggerType": "Consecutive"
                        }
                    }
                }
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/Application')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsEvent",
            "properties": {
                "eventLogName": "Application",
                "eventTypes": [
                    {
                        "eventType": "Error"
                    },
                    {
                        "eventType": "Warning"
                    }
                ]
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/System')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsEvent",
            "properties": {
                "eventLogName": "System",
                "eventTypes": [
                    {
                        "eventType": "Error"
                    },
                    {
                        "eventType": "Warning"
                    }
                ]
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/LogicalDisk1')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Avg Disk sec/Read"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/LogicalDisk2')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Avg Disk sec/Write"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/LogicalDisk3')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Current Disk Queue Length"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/LogicalDisk4')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Disk Transfers/sec"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/LogicalDisk5')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Disk Writes/sec"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/LogicalDisk6')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Free Megabytes"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/LogicalDisk7')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "% Free Space"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/LogicalDisk8')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Disk Reads/sec"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/Memory1')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Available MBytes"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/Memory2')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "% Committed Bytes In Use"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/Network1')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "Network Adapter",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Bytes Received/sec"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/Network2')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "Network Adapter",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Bytes Sent/sec"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/Network3')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "Network Adapter",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Bytes Total/sec"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/CPU1')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "Processor",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "% Processor Time"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/CPU2')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
                "objectName": "Processor",
                "instanceName": "*",
                "intervalSeconds": 360,
                "counterName": "Processor Queue Length"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/LinuxPerformanceCollection')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxPerformanceCollection",
            "properties": {
                "state": "Enabled"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/DiskPerfCounters')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxPerformanceObject",
            "properties": {
                "objectName": "Logical Disk",
                "instanceName": "*",
                "intervalSeconds": 10,
                "performanceCounters": [
                    {
                        "counterName": "% Used Inodes"
                    },
                    {
                        "counterName": "Free Megabytes"
                    },
                    {
                        "counterName": "% Used Space"
                    },
                    {
                        "counterName": "Disk Transfers/sec"
                    },
                    {
                        "counterName": "Disk Reads/sec"
                    },
                    {
                        "counterName": "Disk Writes/sec"
                    },
                    {
                        "counterName": "Disk Read Bytes/sec"
                    },
                    {
                        "counterName": "Disk Write Bytes/sec"
                    }
                ]
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/SyslogCollection')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxSyslogCollection",
            "properties": {
                "state": "Enabled"
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/auth')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxSyslog",
            "properties": {
                "syslogName": "auth",
                "syslogSeverities": [
                    {
                        "severity": "emerg"
                    },
                    {
                        "severity": "alert"
                    },
                    {
                        "severity": "crit"
                    },
                    {
                        "severity": "err"
                    },
                    {
                        "severity": "warning"
                    }
                ]
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/authpriv')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxSyslog",
            "properties": {
                "syslogName": "authpriv",
                "syslogSeverities": [
                    {
                        "severity": "emerg"
                    },
                    {
                        "severity": "alert"
                    },
                    {
                        "severity": "crit"
                    },
                    {
                        "severity": "err"
                    },
                    {
                        "severity": "warning"
                    }
                ]
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/mail')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxSyslog",
            "properties": {
                "syslogName": "mail",
                "syslogSeverities": [
                    {
                        "severity": "emerg"
                    },
                    {
                        "severity": "alert"
                    },
                    {
                        "severity": "crit"
                    },
                    {
                        "severity": "err"
                    },
                    {
                        "severity": "warning"
                    }
                ]
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/daemon')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxSyslog",
            "properties": {
                "syslogName": "daemon",
                "syslogSeverities": [
                    {
                        "severity": "emerg"
                    },
                    {
                        "severity": "alert"
                    },
                    {
                        "severity": "crit"
                    },
                    {
                        "severity": "err"
                    },
                    {
                        "severity": "warning"
                    }
                ]
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/syslog')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxSyslog",
            "properties": {
                "syslogName": "syslog",
                "syslogSeverities": [
                    {
                        "severity": "emerg"
                    },
                    {
                        "severity": "alert"
                    },
                    {
                        "severity": "crit"
                    },
                    {
                        "severity": "err"
                    },
                    {
                        "severity": "warning"
                    }
                ]
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/kern')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxSyslog",
            "properties": {
                "syslogName": "kern",
                "syslogSeverities": [
                    {
                        "severity": "emerg"
                    },
                    {
                        "severity": "alert"
                    },
                    {
                        "severity": "crit"
                    },
                    {
                        "severity": "err"
                    },
                    {
                        "severity": "warning"
                    }
                ]
            }
        },
        {
            "apiVersion": "2020-08-01",
            "type": "Microsoft.OperationalInsights/workspaces/dataSources",
            "name": "[concat(parameters('workspaceName'), '/IISLogs')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "IISLogs",
            "properties": {
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/diagnosticSettings",
            "name": "[concat(parameters('workspaceName'), '/Microsoft.Insights/', parameters('workspaceName'), '-dgs')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            ],
            "apiVersion": "2017-05-01-preview",
            "properties": {
                "name": "[concat(parameters('workspaceName'), '-dgs')]",
                "storageAccountId": "[resourceId(parameters('diagnosticStorageAccountResourceGroup'), 'Microsoft.Storage/storageAccounts', parameters('diagnosticStorageAccountName'))]",
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
                "logs": [
                    {
                        "category": "Audit",
                        "enabled": true,
                        "retentionPolicy": {
                            "days": "[variables('diagnosticRetentionInDays')]",
                            "enabled": true
                        }
                    }
                ],
                "metrics": [
                    {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": {
                            "enabled": true,
                            "days": "[variables('diagnosticRetentionInDays')]"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/locks",
            "name": "[concat(parameters('workspaceName'), '/Microsoft.Authorization/', parameters('workspaceName'), '-lck')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            ],
            "apiVersion": "2017-04-01",
            "properties": {
                "level": "CannotDelete"
            }
        }
    ],
    "outputs": {
        "subscriptionID": {
            "type": "string",
            "value": "[subscription().subscriptionId]"
        }
    }
}
